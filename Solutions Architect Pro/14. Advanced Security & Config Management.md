## Advanced Security & Config Management

> [!tldr] Keeping AWS Workloads Secure
### Amazon GuardDuty

> tldr; Continuous security monitoring service

Analyses supported data sources

AI/ML, it learns patterns about what happens normally in an account

Identifies unexpected and unauthorised activity

If it makes a 'finding' it can notify or trigger an event

Supports multiple accounts (Master and Member)

Once enabled, it ingests:

- DNS Logs
- VPC Flow Logs
- CloudTrail Event Logs
- CloudTrail Management Events
- S3 Data Events

These are analysed for findings

Findings are sent do CloudWatch Events EventBridge

### Amazon Config

> tldr; Records changes over time on resources in an AWS account

e.g. You add rule to security group, this is captured

- Great for auditing changes

- Great for compliance checking

However, it doesn't prevent changes from happening - no protection

It can create standards but doesn't prevent you from breaking them

Regional Service

- Supports cross-region and account aggregation

Can generate SNS notifications and near-real-time events via EventBridge & Lambda

Once enabled, changes are recorded in S3 bucket

The power comes from Config rules

- Define rule, if broken, we can do stuff
- e.g. trigger rule to fix the change
- or notify someone

### Amazon Inspector

> tldr; scans EC2 instances and containers for vulnerabilities

We can run a scan periodically and list vulnerabilities

These produce a report of findings

Network Reachability (no agent needed)

- Reachability end to end
- EC2, ALB, DX, ELB, ENI, IGW, ACLs, RTs, SGs, Subnets, VPCs, VGWs, VPC Peering
- RecognizedPortWithListener, RecognizedPortNoListener, RecognizedPortNoAgent
- UnrecognizedPortWithListener

Agent mode can provide more OS visibility

- Packages
- CVE vulns
- CIS
- Security Best Practices for Inspector (AWS recommended stuff)
### Key Management Service (KMS)

> tldr; create, store, manage cryptographic keys, both symmetric and asymmetric

Regional Service - every region is isolated

Public Service - occupies AWS public zone

Exam: **Keys never leave the product**
- It's primary function is to ensure keys are securely held in the service

Exam: Provides FIPS 140-2 (L2)

CMK Keys = KMS Keys (they were renamed)

A KMS key contains
- id
- date
- policy
- description
- state of key
- backed by physical key material
	- this is what's used to do the encryption/decryption
	- can be generated by kms or imported in
- kms keys can be used for up to **4KB of data**
	- typically used to encrypt other keys!

A KMS key is stored encrypted within KMS

Document -> Send to KMS to encrypt -> KMS encrypts the data

Bigger than 4KB limit = KMS uses DEK (Data Encryption Keys)

KMS doesn't store the DEK
- It provides it to you or the service and then discards it
- 2 versions - plaintext and ciphertext version
- Ciphertext version is encrypted by the KMS key that generated it
- You encrypt the data with the plaintext key then throw it away
- Store encrypted key with data
- That way, you can always provide the encrypted key, KMS will decrypt it
- To decrypt you pass the encrypted DEK back to KMS
- It decrypts it into plain text
- You use this to decrypt the actual data

Exam: Seperation of roles is key (literally)
- Key admin and key use are seperate 

Exam: KMS keys are isolated to the region and never leave
- you cannot extract a KMS key

Multi region keys are supported
- this is done by replication

KMS Keys can either be AWS owned or Customer Owned

KMS Keys support rotation
#### Key Policies and Security
- Key Policy is a resource policy
- Every KMS key has one
- Key doesn't trust the account by default

### CloudHSM

> tldr; similar to KMS but not a shared service

An HSM is a hardware device (tamper resistant) that handles encryption

FIS 140-2 is the industry standard

CloudHSM is a FIS 140-2 compliant Level 3 compliant service
- Unlike KMS which is Level 2 predominantly
- True single tenant HSM
- Provisioned in a CloudHSM VPC, not your VPC
	- Interface Endpoints provided in your VPC
- Need multiple HSMs for HA
- You need a CloudHSM client installed on EC2 instance

AWS can't access the Cryptographic areas in CloudHSM, can't recover keys etc

PKCS#11, Java Cryptography Extensions (JCE), CryptoNG (CNG)

KMS can integrate with CloudHSM as a custom key store

Use Cases:
- CloudHSM has no native AWS integration
	- But can be invoked to encrypt S3
- Offload SSL/TLS processing for web servers
- Enable TDE for Oracle Databases
- Protect Private Keys for Issuing CA

Overall: Good fit for things using industry standard APIs to access HSMs generally things that aren't specific to AWS or if FIPS 140-2 is required

### AWS Certificate Manager (ACM)

> tldr; a public or private certificate authority

When used as a private CA, you need to add ACM as a trusted signer

For Public CA, ACM is one of the trusted providers

Can import or generate certs
- If generated in ACM, it handles the renewal automatically
- If you import, you are responsible

ACM can only deploy certs to supported services

Regional Service - each region is isolated
- If you need a cert in a region, you need a cert in ACM in that particular region
- CF runs in us-east-1 so it needs an ACM cert fro us-east-1
- Cross region is not supported
- Can't use it for EC2 either (not locked down enough)
- S3 doesn't use ACM either

### Systems Manager Parameter Store

> tldr; a way to store and access parameters such as secrets

More secure than storing secrets in the EC2 instance

Stores 3 types of parameters
- Strings
- StringList
- SecureString

Hierarchies and versions
- /wordpress/db_user
- /wordpress/db_pass
- We can pull the entire wordpress group or individual ones

Integrates with KMS to encrypt parameters

Public Parameters
- e.g. Latest AMI in region
- We can look this up via public parameters

Public Service
- Anything using it needs to be an AWS service or have access to AWS public space endpoints
- App, EC2, Lambda

When parameters change, they can kick off events

### Secrets Manager

> tldr; stores secrets like parameter store, but better  for sensitive material like passwords, api keys

Integrated with Console, CLI, API, SDKs
Supports rotation via Lambda
Directly integrates with some AWS products e.g. RDS

Exam: Keyword *rotating secrets*, likely to be Secrets Manager

Integrates with KMS
- You might need access to secret manager and KMS

Rotation is a key feature
- We can rotate the secret and the credential on the backend for supported products
- Application then gets the newer version of the secret when it pull secret from secret manager

Keywords for choosing this over Parameter Store
- Rotation
- Integration with other services
- Just secrets

### VPC Flow Logs

> tldr; captures metadata of vpc traffic, not packet contents

Can be attached to:
- All ENIs in VPC
- Subnet - all ENIs in subnet
- ENIs directly

NOT real time

Can capture metadata on:
- Accepted connections
- Rejected connections
- All connections

Flow Log Records are:
- Source / Dest IP address
- Source / Dest Port
- Action, e.g. ACCEPT OK
- If we see ACCEPT then REJECT immediately after, this can be due to a NACL
- Any traffic to metadata service, Amazon DNS, DHCP, Windows Licensing Server are excluded

Numbers to remember for *traffic types*:
- 1 ICMP
- 6 TCP
- 17 UDP

Targets:
- S3
	- Advantage: you an analyse the log file directly
	- Ingest into 3rd party system
	- Use Athena
- CloudWatch Logs
	- Integrate with other products
	- Access via CW logs console

### AWS WAF

> tldr; AWS's implementation of a Layer 7 firewall

Can protect certain services:
- CloudFront
- ALB
- AppSync
- API Gateway
- ... etc

WAF is the product
- Rules are known as Web ACL
	- Can be things like SQL Injection, Known Botnets, IP reputation
- You associate the rules with a service e.g. CloudFront
- Then the service is protected by the rule

Can protect Global Service e.g. CF or regional ones
- This is configured when you set up the rule
- Create a regional rule or a global rule depending on service

Integrates with other services:
e.g. use EventBridge to crawl public list of bad IPs and a Lambda to update DENY LIST

Output WAF logs to:
- S3
- CW Logs
- Firehose
- Then do event driven processing and analysis
- Automated feedback loop to improve security

WebACLs:
- Default action (ALLOW or BLOCK)
- Resource Type: CloudFront or Regional Service
- ALB, API GW, AppSync -> Pick region
- Add Rule Groups or Rules, these are processed in orders
- Web ACL Capacity Units (WCL) - default maximum 1500 
	- can increase via support ticket
- Adjusting WebACL takes less time than associating one
	- reason: no propogation time
- Doesn't support AWS Outposts

Rule Groups are a container of rules
- No default actions
	- These are defined when groups or rules are added to WEBACLs
- Mostly available for free
	- Can get them from the marketplace
- WCU is defined up-front

Rules: 
- Type, Statement, Action
	- Type: Regular
		- Block an IP
	- Type: Rate-based
		- e.g. connect via SSH 5000 times in a few seconds
- Statement: WHAT to match, or Count ALL, or WHAT & COUNT
	- Origin country, IP, Label, Header, Cookies, Query parameters, URI Path, Query String, Body (first 8192 bytes only), HTTP method
	- These can all be matched with AND OR NOT
- Action:
	- Allow, Block, Count, Captcha, Custom Response (x-amzn-waf-), label
	- Custom response header allows application to react to the block reason
	- Label is internal to WAF, but can be referenced from other rules
		- Labels depend on continued processing
		- Allow and Block stop processing

Pricing:
- WebACL Monthly charge ~ $5 per month
- Rule ~ $1 per month
- Requests per WebACL - Monthly ($0.60 / 1 million)
- Optional extras:
	- Bot control ($10 monthly + $1 per 1m requests)
	- Captcha (0.4/1000 challenge attempts)
	- Fraud control & Account Takeover ($10 pm & $/1000 login attempts)
	- Marketplace roles have extra costs

### AWS Shield

> tldr; Protect any env from DDOS attacks

Two flavours Standard and Advanced
- Standard is free
- Advanced has costs but is way more advanced

Protects against:
- Network Volumetric Attacks (L3)
- Network Protocol attacks (L4) - TCP SYN Flood
	- Leave connections open, prevent new ones
- Application layer attacks (L7)
	- Web request floods
	- E.g. requesting a heavy URL millions of times

How are Shield Standard and Advanced different?

Standard:
- Free
- Protection is at perimeter of network
- Region/VPC or AWS edge
- Protects against common L3 or L4 attacks
- Best protection using R53, CloudFront, AWS Global Accelerator

Advanced:
- $3,000 per month
- 1 year commitment
- Data out charge
- Covers CF, R53, Global Accelerator, Anything associated with EIPs, ALBs, CLBs, NLBs
- Not automatic - must be enabled
	- Do this in Shield Advanced, or AWS Firewall Manager Shield Advanced policy
- Cost protection
	- If you aren't protected against an attack but should have been you get compensated
	- e.g. if 5000 EC2 instance get spun up by a DDOS attack
- Proactive Management
	- Access to Shield Response Team
	- They contact you automatically if there's a possible attack
	- You need to provide contact details in advance
	- You can also contact them through support plan
	- 1 hour or 15 mins SLA
- Integration with WAF
	- Includes basic fees to integrate these protections for WebACLs, rules and web requests
	- Application DDOS protection uses WAF
	- You get real time visibility of DDOS events and attacks
	- Health based detection via Route53
		- Application specific health checks
		- Helps to reduce false positives
		- A requirement for using the proactive response team
	- Protection groups
		- Resources which Shield Advanced protects
		- You can manage them at the group level which decreases overhead

Exam: Remember Shield Advanced needs to be enabled to do anything



















